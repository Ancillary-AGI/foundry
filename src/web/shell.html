<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FoundryEngine - Web Game</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        background-color: #000;
        color: #fff;
        font-family: Arial, sans-serif;
        overflow: hidden;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
      }

      #canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: block;
        image-rendering: -moz-crisp-edges;
        image-rendering: -webkit-crisp-edges;
        image-rendering: -webkit-optimize-contrast;
        image-rendering: pixelated;
        image-rendering: crisp-edges;
        image-rendering: -ms-crisp-edges;
        cursor: none;
      }

      #loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 24px;
        color: #fff;
        text-align: center;
        z-index: 1000;
      }

      #progress {
        width: 300px;
        height: 20px;
        background-color: #333;
        border: 2px solid #666;
        margin: 20px auto;
        border-radius: 10px;
        overflow: hidden;
      }

      #progress-bar {
        height: 100%;
        background-color: #4CAF50;
        width: 0%;
        transition: width 0.3s ease;
      }

      #status {
        margin-top: 20px;
        font-size: 16px;
        color: #ccc;
      }

      #controls {
        position: absolute;
        bottom: 20px;
        left: 20px;
        z-index: 100;
      }

      .control-button {
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        border: 1px solid #666;
        padding: 10px 20px;
        margin: 5px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
      }

      .control-button:hover {
        background-color: rgba(64, 64, 64, 0.7);
      }

      .control-button:active {
        background-color: rgba(128, 128, 128, 0.7);
      }

      #info {
        position: absolute;
        top: 20px;
        right: 20px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px;
        border-radius: 5px;
        font-size: 12px;
        z-index: 100;
      }

      #info p {
        margin: 5px 0;
      }

      .hidden {
        display: none !important;
      }

      /* Mobile-specific styles */
      @media (max-width: 768px) {
        #controls {
          bottom: 10px;
          left: 10px;
        }

        .control-button {
          padding: 8px 16px;
          font-size: 12px;
        }

        #info {
          top: 10px;
          right: 10px;
          font-size: 10px;
        }
      }

      /* Fullscreen styles */
      .fullscreen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 9999;
      }

      /* Touch controls for mobile */
      .touch-controls {
        position: fixed;
        bottom: 50px;
        right: 50px;
        z-index: 1000;
      }

      .touch-button {
        width: 60px;
        height: 60px;
        background-color: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.5);
        border-radius: 50%;
        margin: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
        touch-action: manipulation;
      }

      .touch-button:active {
        background-color: rgba(255, 255, 255, 0.4);
        transform: scale(0.95);
      }

      /* Joystick styles */
      .joystick {
        width: 120px;
        height: 120px;
        background-color: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        position: relative;
        touch-action: none;
      }

      .joystick-knob {
        width: 40px;
        height: 40px;
        background-color: rgba(255, 255, 255, 0.8);
        border-radius: 50%;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        transition: all 0.1s ease;
      }

      /* Hide touch controls on desktop */
      @media (min-width: 769px) {
        .touch-controls {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <div id="loading">
      <h2>Loading FoundryEngine...</h2>
      <div id="progress">
        <div id="progress-bar"></div>
      </div>
      <div id="status">Initializing WebAssembly...</div>
    </div>

    <canvas id="canvas" tabindex="0"></canvas>

    <div id="controls" class="hidden">
      <button class="control-button" onclick="toggleFullscreen()">Fullscreen</button>
      <button class="control-button" onclick="resetGame()">Reset</button>
      <button class="control-button" onclick="toggleDebug()">Debug</button>
    </div>

    <div id="info" class="hidden">
      <p>FPS: <span id="fps">0</span></p>
      <p>Platform: <span id="platform">Web</span></p>
      <p>WebGL: <span id="webgl-version">Unknown</span></p>
      <p>Resolution: <span id="resolution">0x0</span></p>
    </div>

    <!-- Touch controls for mobile -->
    <div class="touch-controls" id="touch-controls">
      <div class="touch-button" id="jump-button" ontouchstart="onJumpTouch(event)" ontouchend="onJumpTouchEnd(event)">â†‘</div>
      <div class="touch-button" id="action-button" ontouchstart="onActionTouch(event)" ontouchend="onActionTouchEnd(event)">A</div>
    </div>

    <!-- Virtual joystick for mobile -->
    <div class="touch-controls" id="joystick-container" style="bottom: 100px; left: 50px;">
      <div class="joystick" id="joystick" ontouchstart="onJoystickTouch(event)" ontouchmove="onJoystickMove(event)" ontouchend="onJoystickEnd(event)">
        <div class="joystick-knob" id="joystick-knob"></div>
      </div>
    </div>

    <script>
      // Global variables
      let Module = {};
      let gameInstance = null;
      let isFullscreen = false;
      let debugMode = false;
      let lastFrameTime = 0;
      let frameCount = 0;
      let fps = 0;

      // Touch control variables
      let joystickActive = false;
      let joystickCenterX = 0;
      let joystickCenterY = 0;
      let joystickKnob = null;
      let jumpButtonPressed = false;
      let actionButtonPressed = false;

      // Initialize the application
      function init() {
        console.log('Initializing FoundryEngine Web Application...');

        // Hide loading screen
        document.getElementById('loading').style.display = 'none';

        // Show controls and info
        document.getElementById('controls').classList.remove('hidden');
        document.getElementById('info').classList.remove('hidden');

        // Setup canvas
        const canvas = document.getElementById('canvas');
        canvas.focus();

        // Setup event listeners
        setupEventListeners();

        // Setup touch controls
        setupTouchControls();

        // Start render loop
        requestAnimationFrame(renderLoop);

        console.log('FoundryEngine Web Application initialized successfully!');
      }

      // Setup event listeners
      function setupEventListeners() {
        const canvas = document.getElementById('canvas');

        // Keyboard events
        canvas.addEventListener('keydown', handleKeyDown);
        canvas.addEventListener('keyup', handleKeyUp);

        // Mouse events
        canvas.addEventListener('mousedown', handleMouseDown);
        canvas.addEventListener('mouseup', handleMouseUp);
        canvas.addEventListener('mousemove', handleMouseMove);
        canvas.addEventListener('wheel', handleMouseWheel);

        // Touch events
        canvas.addEventListener('touchstart', handleTouchStart);
        canvas.addEventListener('touchend', handleTouchEnd);
        canvas.addEventListener('touchmove', handleTouchMove);

        // Context menu
        canvas.addEventListener('contextmenu', function(e) {
          e.preventDefault();
        });

        // Focus events
        canvas.addEventListener('focus', function() {
          console.log('Canvas focused');
        });

        canvas.addEventListener('blur', function() {
          console.log('Canvas blurred');
        });

        // Visibility change
        document.addEventListener('visibilitychange', handleVisibilityChange);

        // Fullscreen change
        document.addEventListener('fullscreenchange', handleFullscreenChange);
      }

      // Setup touch controls
      function setupTouchControls() {
        // Initialize joystick
        const joystick = document.getElementById('joystick');
        const joystickKnob = document.getElementById('joystick-knob');
        joystickCenterX = joystick.offsetLeft + joystick.offsetWidth / 2;
        joystickCenterY = joystick.offsetTop + joystick.offsetHeight / 2;

        // Hide touch controls on desktop
        if (window.innerWidth > 768) {
          document.getElementById('touch-controls').style.display = 'none';
          document.getElementById('joystick-container').style.display = 'none';
        }
      }

      // Keyboard event handlers
      function handleKeyDown(event) {
        if (gameInstance && gameInstance.onKeyDown) {
          gameInstance.onKeyDown(event.keyCode, true);
        }
        event.preventDefault();
      }

      function handleKeyUp(event) {
        if (gameInstance && gameInstance.onKeyUp) {
          gameInstance.onKeyUp(event.keyCode, false);
        }
        event.preventDefault();
      }

      // Mouse event handlers
      function handleMouseDown(event) {
        if (gameInstance && gameInstance.onMouseDown) {
          gameInstance.onMouseDown(event.button, true, event.clientX, event.clientY);
        }
        event.preventDefault();
      }

      function handleMouseUp(event) {
        if (gameInstance && gameInstance.onMouseUp) {
          gameInstance.onMouseUp(event.button, false, event.clientX, event.clientY);
        }
        event.preventDefault();
      }

      function handleMouseMove(event) {
        if (gameInstance && gameInstance.onMouseMove) {
          gameInstance.onMouseMove(event.clientX, event.clientY);
        }
      }

      function handleMouseWheel(event) {
        if (gameInstance && gameInstance.onMouseWheel) {
          gameInstance.onMouseWheel(event.deltaX, event.deltaY);
        }
        event.preventDefault();
      }

      // Touch event handlers
      function handleTouchStart(event) {
        event.preventDefault();

        for (let i = 0; i < event.touches.length; i++) {
          const touch = event.touches[i];
          const touchId = touch.identifier;

          if (gameInstance && gameInstance.onTouchStart) {
            gameInstance.onTouchStart(touchId, touch.clientX, touch.clientY);
          }
        }
      }

      function handleTouchEnd(event) {
        event.preventDefault();

        for (let i = 0; i < event.changedTouches.length; i++) {
          const touch = event.changedTouches[i];
          const touchId = touch.identifier;

          if (gameInstance && gameInstance.onTouchEnd) {
            gameInstance.onTouchEnd(touchId, touch.clientX, touch.clientY);
          }
        }
      }

      function handleTouchMove(event) {
        event.preventDefault();

        for (let i = 0; i < event.touches.length; i++) {
          const touch = event.touches[i];
          const touchId = touch.identifier;

          if (gameInstance && gameInstance.onTouchMove) {
            gameInstance.onTouchMove(touchId, touch.clientX, touch.clientY);
          }
        }
      }

      // Joystick touch handlers
      function onJoystickTouch(event) {
        event.preventDefault();
        joystickActive = true;

        const touch = event.touches[0];
        const rect = document.getElementById('joystick').getBoundingClientRect();
        joystickCenterX = rect.left + rect.width / 2;
        joystickCenterY = rect.top + rect.height / 2;
      }

      function onJoystickMove(event) {
        event.preventDefault();

        if (!joystickActive) return;

        const touch = event.touches[0];
        const deltaX = Math.max(-50, Math.min(50, touch.clientX - joystickCenterX));
        const deltaY = Math.max(-50, Math.min(50, touch.clientY - joystickCenterY));

        // Update joystick knob position
        const knob = document.getElementById('joystick-knob');
        knob.style.left = (50 + deltaX) + 'px';
        knob.style.top = (50 + deltaY) + 'px';

        // Send joystick input to game
        if (gameInstance && gameInstance.onJoystickMove) {
          gameInstance.onJoystickMove(deltaX / 50, deltaY / 50);
        }
      }

      function onJoystickEnd(event) {
        event.preventDefault();
        joystickActive = false;

        // Reset joystick knob position
        const knob = document.getElementById('joystick-knob');
        knob.style.left = '50px';
        knob.style.top = '50px';

        // Send joystick end to game
        if (gameInstance && gameInstance.onJoystickEnd) {
          gameInstance.onJoystickEnd();
        }
      }

      // Button touch handlers
      function onJumpTouch(event) {
        event.preventDefault();
        jumpButtonPressed = true;

        if (gameInstance && gameInstance.onJumpTouch) {
          gameInstance.onJumpTouch(true);
        }
      }

      function onJumpTouchEnd(event) {
        event.preventDefault();
        jumpButtonPressed = false;

        if (gameInstance && gameInstance.onJumpTouch) {
          gameInstance.onJumpTouch(false);
        }
      }

      function onActionTouch(event) {
        event.preventDefault();
        actionButtonPressed = true;

        if (gameInstance && gameInstance.onActionTouch) {
          gameInstance.onActionTouch(true);
        }
      }

      function onActionTouchEnd(event) {
        event.preventDefault();
        actionButtonPressed = false;

        if (gameInstance && gameInstance.onActionTouch) {
          gameInstance.onActionTouch(false);
        }
      }

      // Visibility change handler
      function handleVisibilityChange() {
        if (document.hidden) {
          if (gameInstance && gameInstance.onVisibilityChange) {
            gameInstance.onVisibilityChange(false);
          }
        } else {
          if (gameInstance && gameInstance.onVisibilityChange) {
            gameInstance.onVisibilityChange(true);
          }
        }
      }

      // Fullscreen change handler
      function handleFullscreenChange() {
        isFullscreen = !!document.fullscreenElement;

        if (gameInstance && gameInstance.onFullscreenChange) {
          gameInstance.onFullscreenChange(isFullscreen);
        }
      }

      // Control functions
      function toggleFullscreen() {
        if (!isFullscreen) {
          document.documentElement.requestFullscreen().catch(err => {
            console.log('Fullscreen request failed:', err);
          });
        } else {
          document.exitFullscreen().catch(err => {
            console.log('Fullscreen exit failed:', err);
          });
        }
      }

      function resetGame() {
        if (gameInstance && gameInstance.resetGame) {
          gameInstance.resetGame();
        }
      }

      function toggleDebug() {
        debugMode = !debugMode;
        const info = document.getElementById('info');
        if (debugMode) {
          info.classList.remove('hidden');
        } else {
          info.classList.add('hidden');
        }

        if (gameInstance && gameInstance.toggleDebug) {
          gameInstance.toggleDebug(debugMode);
        }
      }

      // Render loop
      function renderLoop(currentTime) {
        requestAnimationFrame(renderLoop);

        // Calculate FPS
        if (lastFrameTime !== 0) {
          const deltaTime = currentTime - lastFrameTime;
          frameCount++;
          if (deltaTime >= 1000) {
            fps = Math.round((frameCount * 1000) / deltaTime);
            frameCount = 0;
            lastFrameTime = currentTime;

            // Update debug info
            if (debugMode) {
              updateDebugInfo();
            }
          }
        } else {
          lastFrameTime = currentTime;
        }

        // Render game
        if (gameInstance && gameInstance.render) {
          gameInstance.render();
        }
      }

      // Update debug information
      function updateDebugInfo() {
        document.getElementById('fps').textContent = fps;
        document.getElementById('platform').textContent = 'Web';
        document.getElementById('webgl-version').textContent = getWebGLVersion();
        document.getElementById('resolution').textContent = canvas.width + 'x' + canvas.height;
      }

      // Get WebGL version
      function getWebGLVersion() {
        const canvas = document.getElementById('canvas');
        const gl = canvas.getContext('webgl2') || canvas.getContext('webgl') || canvas.getContext('experimental-webgl');

        if (gl) {
          const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
          if (debugInfo) {
            const renderer = gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL);
            return renderer || 'Unknown';
          }
          return 'WebGL';
        }
        return 'Unknown';
      }

      // Error handling
      window.addEventListener('error', function(event) {
        console.error('JavaScript error:', event.error);
      });

      window.addEventListener('unhandledrejection', function(event) {
        console.error('Unhandled promise rejection:', event.reason);
      });

      // Initialize when DOM is loaded
      document.addEventListener('DOMContentLoaded', init);

      // Prevent default touch behaviors
      document.addEventListener('touchstart', function(e) {
        if (e.touches.length > 1) {
          e.preventDefault();
        }
      }, { passive: false });

      document.addEventListener('touchmove', function(e) {
        if (e.touches.length > 1) {
          e.preventDefault();
        }
      }, { passive: false });

      // Prevent zoom on double tap
      let lastTouchEnd = 0;
      document.addEventListener('touchend', function(e) {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
          e.preventDefault();
        }
        lastTouchEnd = now;
      }, false);

      // Prevent context menu on long press
      document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
      });

      console.log('FoundryEngine Web Shell loaded successfully!');
    </script>
  </body>
</html>
