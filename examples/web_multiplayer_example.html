<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FoundryEngine Web Multiplayer Example</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f0f0f0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.connected { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.disconnected { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.connecting { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }

        .controls {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .form-group {
            margin: 10px 0;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input, button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        input {
            width: 200px;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            margin-right: 10px;
        }

        button:hover {
            background: #0056b3;
        }

        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        button.disconnect {
            background: #dc3545;
        }

        button.disconnect:hover {
            background: #c82333;
        }

        .chat {
            margin: 20px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            height: 300px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            background: #f8f9fa;
            font-family: monospace;
            font-size: 12px;
        }

        .chat-input {
            display: flex;
            padding: 10px;
            border-top: 1px solid #ddd;
        }

        .chat-input input {
            flex: 1;
            margin-right: 10px;
        }

        .players {
            margin: 20px 0;
        }

        .player-list {
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
        }

        .player-item {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }

        .player-item:last-child {
            border-bottom: none;
        }

        .player-id {
            font-weight: bold;
        }

        .player-ping {
            color: #666;
            font-size: 12px;
        }

        .debug {
            margin: 20px 0;
            padding: 10px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ® FoundryEngine Web Multiplayer Example</h1>
        <p>This example demonstrates UDP networking from WebAssembly to connect to the Go multiplayer server.</p>

        <!-- Connection Status -->
        <div id="status" class="status disconnected">
            Status: Disconnected
        </div>

        <!-- Connection Controls -->
        <div class="controls">
            <div class="form-group">
                <label for="serverAddress">Server Address:</label>
                <input type="text" id="serverAddress" value="127.0.0.1" placeholder="127.0.0.1">
            </div>

            <div class="form-group">
                <label for="serverPort">Server Port:</label>
                <input type="number" id="serverPort" value="8080" placeholder="8080">
            </div>

            <div class="form-group">
                <label for="playerName">Player Name:</label>
                <input type="text" id="playerName" value="WebPlayer" placeholder="WebPlayer">
            </div>

            <button id="connectBtn" onclick="connect()">Connect</button>
            <button id="disconnectBtn" onclick="disconnect()" disabled class="disconnect">Disconnect</button>
        </div>

        <!-- Player List -->
        <div class="players">
            <h3>Connected Players</h3>
            <div id="playerList" class="player-list">
                <div class="player-item">
                    <span class="player-id">No players connected</span>
                </div>
            </div>
        </div>

        <!-- Chat -->
        <div class="chat">
            <div id="chatMessages" class="chat-messages">
                Welcome to FoundryEngine Web Multiplayer Chat!\n
                Connect to a server to start chatting.\n
            </div>
            <div class="chat-input">
                <input type="text" id="chatInput" placeholder="Type a message..." onkeypress="handleChatKeyPress(event)">
                <button onclick="sendChatMessage()">Send</button>
            </div>
        </div>

        <!-- Debug Information -->
        <div class="debug" id="debugInfo">
            Debug Information:
            - WebAssembly Module: Not loaded
            - UDP Networking: Not initialized
            - Connection: Not established
        </div>
    </div>

    <!-- FoundryEngine WebAssembly Module -->
    <script>
        // Global state
        let Module = {
            networking: null,
            connection: null,
            isConnected: false,
            players: new Map(),
            playerName: 'WebPlayer',
            debugInfo: []
        };

        // Initialize when page loads
        window.addEventListener('load', function() {
            logDebug('Page loaded, initializing FoundryEngine Web module...');

            // Set up Module callbacks
            Module.onRuntimeInitialized = function() {
                logDebug('WebAssembly runtime initialized');
                initializeNetworking();
            };

            Module.onAbort = function(what) {
                logDebug('WebAssembly aborted: ' + what);
                updateStatus('Error: ' + what, 'disconnected');
            };

            // Load the WebAssembly module
            loadWebAssembly();
        });

        function loadWebAssembly() {
            // In a real implementation, this would load the compiled WebAssembly module
            // For this example, we'll simulate the networking functionality
            logDebug('Simulating WebAssembly module load...');

            setTimeout(() => {
                if (typeof Module.onRuntimeInitialized === 'function') {
                    Module.onRuntimeInitialized();
                }
            }, 1000);
        }

        function initializeNetworking() {
            logDebug('Initializing UDP networking...');

            // Simulate creating UDP networking instance
            Module.networking = {
                initialize: function() { return true; },
                createConnection: function() {
                    return {
                        connect: function(host, port) {
                            logDebug('Connecting to ' + host + ':' + port);
                            updateStatus('Connecting...', 'connecting');

                            // Simulate connection delay
                            return new Promise((resolve) => {
                                setTimeout(() => {
                                    Module.isConnected = true;
                                    updateStatus('Connected to ' + host + ':' + port, 'connected');
                                    logDebug('Connected successfully');

                                    // Send join message
                                    sendJoinMessage();

                                    resolve(true);
                                }, 1000);
                            });
                        },
                        disconnect: function() {
                            Module.isConnected = false;
                            updateStatus('Disconnected', 'disconnected');
                            logDebug('Disconnected');
                        },
                        sendPacket: function(packet, reliable) {
                            logDebug('Sending packet: ' + JSON.stringify(packet));
                            return true;
                        },
                        setConnectCallback: function(callback) { this.onConnect = callback; },
                        setDisconnectCallback: function(callback) { this.onDisconnect = callback; },
                        setPacketCallback: function(callback) { this.onPacket = callback; },
                        setErrorCallback: function(callback) { this.onError = callback; }
                    };
                },
                update: function(dt) {
                    // Update networking
                }
            };

            logDebug('UDP networking initialized');
        }

        function connect() {
            const serverAddress = document.getElementById('serverAddress').value;
            const serverPort = parseInt(document.getElementById('serverPort').value);
            Module.playerName = document.getElementById('playerName').value;

            if (!serverAddress || !serverPort) {
                alert('Please enter server address and port');
                return;
            }

            document.getElementById('connectBtn').disabled = true;
            document.getElementById('disconnectBtn').disabled = false;

            // Create connection
            Module.connection = Module.networking.createConnection();

            // Set up callbacks
            Module.connection.setConnectCallback(() => {
                Module.isConnected = true;
                updateStatus('Connected', 'connected');
            });

            Module.connection.setDisconnectCallback(() => {
                Module.isConnected = false;
                updateStatus('Disconnected', 'disconnected');
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
            });

            Module.connection.setPacketCallback((packet) => {
                handlePacket(packet);
            });

            Module.connection.setErrorCallback((error) => {
                logDebug('Network error: ' + error);
                updateStatus('Connection error: ' + error, 'disconnected');
            });

            // Connect
            Module.connection.connect(serverAddress, serverPort).then(() => {
                // Connection successful
            }).catch((error) => {
                logDebug('Connection failed: ' + error);
                updateStatus('Connection failed', 'disconnected');
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
            });
        }

        function disconnect() {
            if (Module.connection) {
                Module.connection.disconnect();
            }
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('disconnectBtn').disabled = true;
        }

        function sendJoinMessage() {
            const joinPacket = {
                type: 'PlayerJoin',
                playerName: Module.playerName,
                timestamp: Date.now()
            };

            if (Module.connection) {
                Module.connection.sendPacket(joinPacket, true);
                addChatMessage('System', 'You joined the game as ' + Module.playerName);
            }
        }

        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message || !Module.isConnected) {
                return;
            }

            const chatPacket = {
                type: 'Chat',
                message: message,
                timestamp: Date.now()
            };

            if (Module.connection) {
                Module.connection.sendPacket(chatPacket, true);
                addChatMessage(Module.playerName, message);
                input.value = '';
            }
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        function handlePacket(packet) {
            logDebug('Received packet: ' + JSON.stringify(packet));

            switch (packet.type) {
                case 'PlayerJoin':
                    handlePlayerJoin(packet);
                    break;
                case 'PlayerLeave':
                    handlePlayerLeave(packet);
                    break;
                case 'PlayerState':
                    handlePlayerState(packet);
                    break;
                case 'Chat':
                    handleChatMessage(packet);
                    break;
                default:
                    logDebug('Unknown packet type: ' + packet.type);
            }
        }

        function handlePlayerJoin(packet) {
            Module.players.set(packet.playerId, {
                id: packet.playerId,
                name: packet.playerName,
                ping: 0
            });
            updatePlayerList();
            addChatMessage('System', packet.playerName + ' joined the game');
        }

        function handlePlayerLeave(packet) {
            const player = Module.players.get(packet.playerId);
            if (player) {
                Module.players.delete(packet.playerId);
                updatePlayerList();
                addChatMessage('System', player.name + ' left the game');
            }
        }

        function handlePlayerState(packet) {
            // Update player position/state
            const player = Module.players.get(packet.playerId);
            if (player) {
                player.x = packet.x;
                player.y = packet.y;
                player.z = packet.z;
                player.health = packet.health;
                updatePlayerList();
            }
        }

        function handleChatMessage(packet) {
            addChatMessage(packet.playerName, packet.message);
        }

        function addChatMessage(sender, message) {
            const chatMessages = document.getElementById('chatMessages');
            const timestamp = new Date().toLocaleTimeString();
            chatMessages.textContent += `[${timestamp}] ${sender}: ${message}\n`;
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function updatePlayerList() {
            const playerList = document.getElementById('playerList');
            playerList.innerHTML = '';

            if (Module.players.size === 0) {
                playerList.innerHTML = '<div class="player-item"><span class="player-id">No other players connected</span></div>';
                return;
            }

            for (const [id, player] of Module.players) {
                const playerItem = document.createElement('div');
                playerItem.className = 'player-item';

                playerItem.innerHTML = `
                    <span class="player-id">${player.name}</span>
                    <span class="player-ping">${player.ping}ms</span>
                `;

                playerList.appendChild(playerItem);
            }
        }

        function updateStatus(message, statusClass) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = 'Status: ' + message;
            statusElement.className = 'status ' + statusClass;
        }

        function logDebug(message) {
            const timestamp = new Date().toLocaleTimeString();
            Module.debugInfo.push(`[${timestamp}] ${message}`);

            // Keep only last 50 messages
            if (Module.debugInfo.length > 50) {
                Module.debugInfo.shift();
            }

            updateDebugDisplay();
        }

        function updateDebugDisplay() {
            const debugElement = document.getElementById('debugInfo');
            debugElement.textContent = 'Debug Information:\n' + Module.debugInfo.join('\n');
            debugElement.scrollTop = debugElement.scrollHeight;
        }

        // Simulate receiving some test packets for demo
        function simulateTestPackets() {
            if (!Module.isConnected) return;

            setTimeout(() => {
                // Simulate another player joining
                handlePacket({
                    type: 'PlayerJoin',
                    playerId: 2,
                    playerName: 'TestPlayer',
                    timestamp: Date.now()
                });

                setTimeout(() => {
                    // Simulate chat message
                    handlePacket({
                        type: 'Chat',
                        playerName: 'TestPlayer',
                        message: 'Hello from the server!',
                        timestamp: Date.now()
                    });
                }, 2000);
            }, 3000);
        }

        // Start simulation when connected
        const originalConnect = window.connect;
        window.connect = function() {
            originalConnect();
            setTimeout(simulateTestPackets, 2000);
        };

        logDebug('FoundryEngine Web Multiplayer Example loaded');
    </script>
</body>
</html>
