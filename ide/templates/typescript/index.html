<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A game built with Foundry Engine and TypeScript">
    <meta name="author" content="Your Name">
    <title>Foundry TypeScript Game</title>

    <!-- Preload critical resources -->
    <link rel="preload" href="main.js" as="script">
    <link rel="preload" href="foundry-engine.js" as="script">

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">

    <!-- Styles -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #game-canvas {
            display: block;
            max-width: 100%;
            max-height: 100%;
            background: #1a1a1a;
            border: none;
            outline: none;
        }

        #loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.5s ease-out;
        }

        #loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 18px;
            font-weight: 300;
            margin-bottom: 10px;
        }

        .loading-progress {
            width: 300px;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            overflow: hidden;
        }

        .loading-progress-bar {
            height: 100%;
            background: #ffffff;
            width: 0%;
            transition: width 0.3s ease;
        }

        .loading-details {
            font-size: 14px;
            opacity: 0.8;
            margin-top: 10px;
        }

        #error-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #2d1b1b;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
            z-index: 1001;
        }

        .error-icon {
            font-size: 48px;
            margin-bottom: 20px;
            color: #ff6b6b;
        }

        .error-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #ff6b6b;
        }

        .error-message {
            font-size: 16px;
            margin-bottom: 20px;
            color: #cccccc;
            max-width: 600px;
        }

        .error-details {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            color: #ff9999;
            margin-bottom: 20px;
            max-width: 600px;
            text-align: left;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .error-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: #007acc;
            color: white;
        }

        .btn-primary:hover {
            background: #005a9e;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .loading-text {
                font-size: 16px;
            }

            .loading-progress {
                width: 250px;
            }

            .error-title {
                font-size: 20px;
            }

            .error-message {
                font-size: 14px;
            }
        }

        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {
            .loading-spinner {
                animation: none;
            }

            #loading-screen {
                transition: none;
            }
        }

        /* High contrast mode */
        @media (prefers-contrast: high) {
            body {
                background: #000;
                color: #fff;
            }

            #game-canvas {
                border: 2px solid #fff;
            }
        }

        /* Print styles */
        @media print {
            body {
                background: white !important;
                color: black !important;
            }

            #game-container,
            #loading-screen,
            #error-screen {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <!-- Game Container -->
    <div id="game-container">
        <!-- Game Canvas -->
        <canvas id="game-canvas" tabindex="0" aria-label="Game Canvas"></canvas>

        <!-- Loading Screen -->
        <div id="loading-screen">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading Foundry Game...</div>
            <div class="loading-progress">
                <div class="loading-progress-bar" id="loading-progress-bar"></div>
            </div>
            <div class="loading-details" id="loading-details">Initializing engine...</div>
        </div>

        <!-- Error Screen -->
        <div id="error-screen">
            <div class="error-icon">⚠️</div>
            <div class="error-title">Game Failed to Load</div>
            <div class="error-message" id="error-message">
                There was an error loading the game. Please check your browser compatibility and try again.
            </div>
            <div class="error-details" id="error-details"></div>
            <div class="error-actions">
                <button class="btn btn-primary" onclick="window.location.reload()">Reload Game</button>
                <button class="btn btn-secondary" onclick="reportError()">Report Issue</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Global error handling
        window.addEventListener('error', function(event) {
            showError(event.error || event.message, event.filename + ':' + event.lineno + ':' + event.colno);
        });

        window.addEventListener('unhandledrejection', function(event) {
            showError('Unhandled Promise Rejection: ' + event.reason);
        });

        // Loading management
        let loadingProgress = 0;
        const loadingDetails = document.getElementById('loading-details');
        const loadingProgressBar = document.getElementById('loading-progress-bar');

        function updateLoadingProgress(progress, detail) {
            loadingProgress = Math.min(100, Math.max(0, progress));
            loadingProgressBar.style.width = loadingProgress + '%';

            if (detail) {
                loadingDetails.textContent = detail;
            }

            if (loadingProgress >= 100) {
                setTimeout(() => {
                    document.getElementById('loading-screen').classList.add('hidden');
                }, 500);
            }
        }

        function showError(error, stack) {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('error-screen').style.display = 'flex';

            const errorMessage = document.getElementById('error-message');
            const errorDetails = document.getElementById('error-details');

            errorMessage.textContent = typeof error === 'string' ? error : error.message || 'Unknown error occurred';
            errorDetails.textContent = stack || (error.stack || 'No stack trace available');

            console.error('Game Error:', error);
        }

        // Browser compatibility check
        function checkBrowserCompatibility() {
            const canvas = document.getElementById('game-canvas');
            const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');

            if (!gl) {
                showError('WebGL is not supported by your browser. Please update to a modern browser that supports WebGL.');
                return false;
            }

            // Check for required features
            const requiredFeatures = [
                'WebGLRenderingContext',
                'WebAssembly',
                'Promise',
                'Map',
                'Set',
                'WeakMap',
                'Array.from',
                'Object.assign'
            ];

            for (const feature of requiredFeatures) {
                if (typeof window[feature] === 'undefined') {
                    showError(`Your browser does not support required feature: ${feature}`);
                    return false;
                }
            }

            return true;
        }

        // Performance monitoring
        let frameCount = 0;
        let lastTime = performance.now();
        let fps = 0;

        function updatePerformance() {
            frameCount++;
            const currentTime = performance.now();

            if (currentTime - lastTime >= 1000) {
                fps = Math.round((frameCount * 1000) / (currentTime - lastTime));
                frameCount = 0;
                lastTime = currentTime;

                // Update performance info (can be displayed in UI)
                window.gameFPS = fps;
            }

            requestAnimationFrame(updatePerformance);
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initialize);
        } else {
            initialize();
        }

        function initialize() {
            if (!checkBrowserCompatibility()) {
                return;
            }

            updateLoadingProgress(10, 'Checking browser compatibility...');
            updatePerformance();

            // Start loading game
            updateLoadingProgress(20, 'Loading game engine...');

            // The main game script will be loaded by webpack
            // Error handling is done above
        }

        // Global functions for game interaction
        window.reportError = function() {
            const errorDetails = document.getElementById('error-details').textContent;
            const errorMessage = document.getElementById('error-message').textContent;

            // Send error report to server
            fetch('/api/errors', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: errorMessage,
                    details: errorDetails,
                    userAgent: navigator.userAgent,
                    url: window.location.href,
                    timestamp: new Date().toISOString()
                })
            }).catch(err => {
                console.error('Failed to report error:', err);
            });

            alert('Error report sent. Thank you for helping improve the game!');
        };

        // Service worker for offline support (optional)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registered');
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed:', error);
                    });
            });
        }

        // Prevent context menu on game canvas
        document.getElementById('game-canvas').addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });

        // Handle fullscreen
        window.addEventListener('keydown', function(e) {
            if (e.key === 'F11' || (e.ctrlKey && e.key === 'f')) {
                e.preventDefault();
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                } else {
                    document.exitFullscreen();
                }
            }
        });
    </script>

    <!-- Load game scripts -->
    <script src="vendors.js"></script>
    <script src="foundry-engine.js"></script>
    <script src="main.js"></script>
    <script src="backend.js"></script>
</body>
</html>